# 파일 시스템

- 파일과 디렉터리를 보조기억장치에 일목요연하게 저장하고 접근하기 위한 운영체제 **내부 프로그램**
- 파일 시스템에는 여러 종류가 있고, 하나의 컴퓨터라도 여러 파일 시스템 사용가능
- FAT 파일 시스템
- 유닉스 파일 시스템

# 파티셔닝과 포매팅

- 새 하드디스크, 새 SSD는 바로 사용 불가
- 보조기억장치는 사용 전에 파티션을 나누는 **파티셔닝**과 포맷 작업(**포매팅**)을 거쳐야함

## 파티셔닝 (partioning)

- 파티셔닝 : 저장 장치의 논리적인 영역을 구획하는 작업
- 쉽게 생각해서 칸막이로 용도에 맞게 영역을 나누는 작업
- 하드 디스크나 SSD 같이 용량이 큰 저장장치를 하나 이상의 논리적인 단위로 구획
- 하나하나 나눠진 구역을 **파티션**(partition)라고 함

## 포매팅(formatting)

- 저장 장치의 데이터를 완전히 삭제하는 걸로 알고 있지만 부정확한 개념
- 파일 시스템을 설정하여 어떤 방식으로 파일을 저장하고 관리할 것인지 결정하고, 새로운 데이터를 쓸 준비를 하는 작업
- 어떤 종류의 **파일 시스템**을 사용할지 이때 결정
- 실제로 USB를 포맷할때 파일시스템을 선택한다 (EX FAT32 등등)
- 파티션마다 다른 파일 시스템을 선택할수 있다
- 포매팅 종류
  - 저수준 포매팅 : 물리적 포매팅, 저장 장치를 생성할때 공장에서 직접 수행
  - 논리적 포매팅 : 파일 시스템을 생성하는 포매팅, 보통 이 포매팅을 포매팅이라고 함

# 파일 할당 방법

- 운영체제는 파일과 디렉터리를 **블록**(block)단위로 읽고 쓴다. (윈도우는 **클러스터**라고 함)
- 하나의 파일이 보조기억장치에 저장될때는 하나 이상의 블록에 걸쳐 저장된다
- 하드디스크의 가장 작은 저장 단위 = 섹터
- 운영체제는 하나 이상의 섹터를 블록이라는 단위로 묶은 뒤 블록 단위로 파일과 디렉터리 관리
- 파일 시스템이 모든 섹터를 관리하기에는 개수가 너무 많고 크기도 작다
- 파일 할당의 종류
  - 연속 할당
  - 불연속 할당
    - 연결 할당
    - 색인 할당
- 대부분 운영체제는 불연속 할당 사용

## 연속할당(contiguous allocation)

- 연속적인 블록에 파일을 할당하는 가장 단순한 방식
- 디렉터리 엔트리에는 파일 이름, 첫번째 블록의 주소, 블록 단위의 길이(몇개)만 명시하면 된다
- 파일의 첫 블록 주소와, 블록의 단위 길이만 알면 파일에 접근가능
- **외부 단편화** 문제 발생

## 연결 할당 (linked allocation)

- 각 블록 일부에 다음 블록의 주소를 저장하여 각 블록이 다음 블록을 가리키는 형태로 할당하는 방식
- 대표적으로 FAT 파일 시스템 (기반은 연결할당이지만 많이 바꿈)
- 즉 연결리스트로 관리하는 방식이다
- 디렉터리 엔트리에는 역시 파일 이름, 첫번째 블록의 주소, 길이가 명시됨
- 외부 단편화 문제가 해결됨
- 단점
  - 반드시 첫번째 블록부터 하나씩 차례대로 읽어야함 => 임의 접근(random acess)가 매우 느림
  - 하드웨어 고장이나 오류 발생시 해당 블록이후에 전부 접근 불가

## 색인 할당 (indexed allocation)

- 파일 모든 블록 주소를 **색인 블록**(index block)이라는 하나의 블록에 모아 관리하는 방식
- 한 파일의 데이터를 접근하기 위해서는, 색인블록에 저장되어있는 주소에 차례대로 접근
- 디렉터리 엔트리에는 파일 이름과 **색인 블록 주소**를 저장
- 색인 할당 기반으로 만든 파일 시스템이 유닉스 파일 시스템

# 파일 시스템

## FAT 파일 시스템

- USB, SD 카드등 저용량 장치에서 사용
- FAT12, 16,32 등등 모두 FAT 파일 시스템의 종류 (숫자는 블록을 표현하는 비트수)
- 연결 할당의 단점을 보완 (블록안에 다음 블록의 주소가 있음)
- 각 블록에 포함된 다음 블록의 주소들을 한데 모아 테이블 형태로 관리함
- 이 테이블 이름을 **파일 할당 테이블**(FAT, File Allocation Table)이라고 한다
- 디렉터리 엔트리에는 파일 이름과 첫 번째 블록 주소를 명시한다
- FAT를 사용하는 FAT 파일 시스템이라고 한다
- FAT 파일 시스템에서 FAT는 파티션의 앞부분에 만들어진다
- 하드 디스크의 한 파티션을 FAT 파일 시스템으로 포맷하면 다음과 같이 나눠진다
  - 예약 영역
  - FAT 영역
  - 루트 디렉터리 영역
  - 데이터 영역 (데이터 + 디렉터리)
- FAT는 하드 디스크 파티션 시작 부분에 있지만, 실행 도중 FAT가 메모리에 캐시될수도 있다
- FAT가 메모리에 적재된 채 실행되면 기존 연결 할당보다 다음 블록을 찾는 속도가 빨라짐 (임의접근이 빨라짐)
- FAT 파일 시스템의 디렉터리 저장 방법 (디렉터리도 일종의 파일이므로)
  - 파일 이름
  - 확장자
  - 속성 : 읽기 전용, 숨김, 시스템 파일, 일반 파일, 디렉터리인지 등등 식별용
  - 예약 영역
  - 생성 시간
  - 마지막 접근 시간
  - 마지막 수정 시간
  - 시작 블록 : FAT 파일 시스템의 시작 블록
  - 파일 크기

## 유닉스 파일 시스템

- 색인 할당 기반, 유닉스에선 색인 블록을 **i-node**(index-node)라고 함
- 유닉스 계열 운영체제에서 사용
- i-node에는 파일 속성 정보(파일크기, 수정시간 등등..)와 15개의 블록 주소가 저장될수있다.
- 유닉스 파일 시스템에서는 파일 속성 정보가 디렉터리 엔트리가 아닌 i-node에 표시
- 유닉스 파일 시스템에서는 파일마다 i-node가 있고, i-node마다 번호가 부여되어 있다
- 유닉스 파일 시스템의 하드 디스크
  - 예약 영역
  - i-node 영역
  - 데이터 영역 (데이터 + 디렉터리)
- i-node는 15개까지 블록 주소를 기억할수 있기 때문에, 15개 블록이 넘는 사이즈의 파일은 다른 방식으로 표현해야함
- i-node의 15개의 블록 주소중 첫 12개의 블록주소는 직접적으로 블록 주소를 명시
- 이를 **직접 블록**(direct block)이라고 한다
- 12개의 직접 블록으로 파일의 모든 블럭을 가리킬 수 없다면, 13번째 블록 주소로 **단일 간접 블록**(single indirect block)을 사용
- 단일 간접블록으로 파일 데이터가 저장된 블록주소로 다른 블록들을 저장함
- 단일 간접블록으로 모든 블록을 가리킬수 없다면, 14번째 블록 주소로 **이중 간접 블록**(double indirect block)을 사용해 주소를 저장
- **이중 간접 블록**은 단일 간접블록들의 주소를 저장하는 블록
- 14개의 블록으로 모든 파일 블록을 가리킬수 없다면, 15번째 블록 주소르 **삼중 간접 블록**을 이용
- **삼중 간접 블록**은 이중 간접 블록 주소가 저장된 블록 => 어지간하면 대부분 저장 가능
- 유닉스 파일 시스템의 디렉터리 엔트리
  - i-node 번호
  - 파일 이름
- 파일 시스템은 루티 디렉터리의 i-node는 언제나 기억하고 있다

# 추가 학습

## 윈도우의 NT 파일시스템(NTFS)

## 리눅스의 ext파일 시스템

# 저널링 파일 시스템

- **시스템 크래시**: 컴퓨터가 작업을 하던 도중 전원이 나가거나, 치명적인 오류로 컴퓨터가 강제로 종료되어 버린 상황
- 파일 시스템을 변경중 시스템 크래시가 발생하면 파일 시스템이 훼손될수 있음
- 저널링 파일 시스템이 있기 전에는 시스템 크래시 후 부팅 직후 파일 시스템을 검사하고 복구하는 프로그램을 돌림
  - 유닉스 리눅스의 fsck
  - 윈도우 scandisk
  - 등등
- 전체 블록을 확인해야해서 너무 오래걸리는 단점이 있었다
- **저널링 기법**(journaling) : 작업 로그를 통해 시스템 크래시가 발생했을 때 빠르게 복구하는 기법

1. 작업 직전 파티션의 로그 영역에 수행하는 작업(변경 사항)에 대한 로그를 남긴다.
2. 로그를 남긴후 작업을 수행한다
3. 작업이 끝났다면 로그를 삭제한다

- 시스템 크래시가 발생해서 다시 부팅하면, 로그 영역을 확인해 해당 작업만 수행해주면 됨
- 현대 대부분 OS는 저널링 기법을 지원함

# 마운트

- 유닉스, 리눅스 등의 운영체제에서 저장 장치를 '마운트'한다는 표현을 자주 쓴다
- 마운트: 한 저장 장치의 파일 시스템에서 다른 저장 장치의 파일 시스템에 접근할수 있도록, 파일 시스템을 편입 시키는 작업
- 예를 들어 USB를 연결했을때 USB를 컴퓨터의 한 디렉터리에 **마운트**하면 해당 디렉토리 접근하듯이 USB에 접근이 가능해짐
