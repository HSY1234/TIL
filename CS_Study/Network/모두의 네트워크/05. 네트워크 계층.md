# 네트워크 계층

- 서로 다른 네트워크에 있는 목적지로 데이터를 전송하기 위해 필요한 기술 계층
- **네트워크 간의 통신을 가능하게 하는 것**이 **네트워크 계층의 역할**
- 데이터 링크 계층에서는 이더넷 규칙을 기반으로 데이터 전송을 담당, 이 규칙으로는 같은 네트워크에 있는 컴퓨터에는 데이터를 전송할수 있지만, 인터넷이나 다른 네트워크로는 데이터 전송 불가능
- 네트워크 계층의 장비 **라우터**(router) or L3 스위치
- 집에서 사용하는 공유기도 일종의 라우터이다
- 라우터는 데이터의 목적지가 정해지면 **해당 목적지까지 어떤 경로로 가는것이 좋은지** 알려주는 기능을 한다
- 라우터도 데이터를 보내려는 상대가 어디 있는지 모르면 경로를 알수 없다
- 랜에서는 MAC 주소만으로 통신이 가능하지만, 다른 네트워크에는 데이터를 MAC주소로 바로 보낼수 없다
- MAC 주소가 아닌 네트워크를 식별할수 있는 다른 주소가 필요하다! => **IP 주소**
- **IP 주소** : **어떤 네트워크**의 **어떤 컴퓨터**인지 식별하기 위한 주소
- 목적지를 IP주소로 지정하면, 데이터를 어떤 경로로 보낼지도 결정해야한다.
- 목적지 IP주소까지 어떤 경로로 데이터를 보낼지 결정하는 것을 **라우팅(routing)**이라고 한다
- 라우팅은 라우터나 레이어3 스위치(L3 스위치)가 담당
- 라우터를 사용하여 거리에 관계 없이 다른 네트워크로 데이터를 보낼수 있다.
- 라우터는 **라우팅 테이블**(routing table)이 있어서 경로 정보를 등록하고 관리

# IP (Internet Protocol)

- IP: 네트워크 계층의 프로토콜중 하나
- 데이터를 다른 네트워크에 있는 목적지까지 보내는 라우터는 IP 프로토콜을 사용한다
- TCP/IP 프로토콜의 IP
- 네트워크 계층에서 캡슐화시 **IP 헤더** 붙임
- IP 헤더의 구조
  - 버전 (version)
  - 헤더 길이 (header length)
  - 서비스 유형 (service type)
  - 전체 패킷 길이 (total length)
  - ID (identification)
  - 조각 상태 (flags)
  - 조각의 위치 (fragement offset)
  - TTL (Time To Live)
  - 프로토콜 (protocol)
  - 헤더 체크섬 (header checksum)
  - 출발지 IP (source IP address) 32bit
  - 목적지 IP (destination IP address) 32bit
- 네트워크 계층에서 IP프로토콜을 사용해 IP헤더가 추가된 데이터를 **IP 패킷**이라고 한다
- 데이터링크 계층 **프레임**, 네트워크 계층 **IP 패킷**

## IP주소 (Internet Protocol address)

- IP주소는 특정 네트워크의 주소와 같다 (실생활의 주소처럼)
- IP 주소는 **ISP**에게 받을 수 있다.
- IP 버전
  - IPv4 : 32bit, 약 43억개 주소 표현 가능
  - IPv6 : 128bit, 340간개 거의 무한대
  - 최근에는 IPv4 와 IPv6를 공존해서 사용
- IP 주소
  - 공인 IP주소 : 인터넷에 직접 연결되는 컴퓨터나 라우터에 할당해주는 ISP에서 제공한 IP 주소
  - 사설 IP주소 : 회사나 가정 랜에 있는 컴퓨터가 할당 받는 IP주소
  - 공인 IP, 사설 IP 주소 모두 2진수의 32비트를 동일 하게 사용
- 예를 들어 같은 랜안에 컴퓨터가 여러대 있다면, 컴퓨터 한대당 공인 IP주소를 할당하지 않고
- ISP가 제공하는 공인 IP주소는 라우터에만 할당하고
- 랜 안에 있는 컴퓨터에는 랜의 네트워크 관리자가 자유롭게 사설 IP주소를 할당 or **DHCP**기능으로 주소를 자동으로 할당
- DHCP (Dynamic Host Configuration Protocol) : IP주소를 자동으로 할당하는 프로토콜
- 이런식으로 공인 IP주소 한개로 랜 안에 있는 컴퓨터 모두 인터넷에 연결할수 있는 환경 구성

## IP주소 표현 방법

- MAC 주소는 48비트를 16진수로 표현 : 02:46:8A:CE:00:FF or 02-46-8A-CE-00-FF
- IP 주소는 32비트를 10진수로 표현 : 192.168.1.10
- IP 주소를 8비트 단위로 나눠 10진수로 표현하고 8비트를 **옥텟**이라고 부른다
- 옥텟은 8비트 이므로, 0~255 사이의 숫자로 표현된다
- IP주소의 구성
  - 네트워크 ID (네트워크 주소)
  - 호스트 ID (호스트 주소)

## IP주소의 클래스 (IP address class)

- 32비트에서 네트워크 ID를 크게 만들거나, 호스트 ID를 작게 만들어 네트워크 크기 조정
- 네트워크 크기를 **클래스**라는 개념으로 구분
- 클래스의 종류
  - A클래스 : 대규모 네트워크 주소
  - B클래스 : 중형 네트워크 주소
  - C클래스 : 소규모 네트워크 주소
  - D클래스 : 멀티캐스트 주소
  - E클래스 : 연구 및 특수용도 주소
- 일반 네트워크는 A~C 클래스를 사용
  - A 클래스 처음 8비트가 네트워크 ID, 24비트가 호스트 ID
  - B 클래스 처음 16비트가 네트워크 ID, 16비트가 호스트 ID
  - C 클래스 처음 24비트가 네트워크 ID, 8비트가 호스트 ID
- 호스트 주소는 **모두가 1인 경우 브로드캐스트용**, **모두가 0인 경우 네트워크 주소**로 사용하기 때문에 2개를 뺀다
- A클래스 (0으로 시작)
  - 첫 1옥텟 범위 : 1~127 (00000001 ~ 01111111)
  - 2~4 옥텟 범위 : 0~255
  - 최대 호스트 수 : 1677만 7214대 (256\*256\*256 -2)
  - 범위 : 1.0.0.0 ~ 127.255.255.255
- B클래스 (10으로 시작)
  - 첫 1옥텟 범위 : 128~191 (10000000 ~ 10111111)
  - 2~4 옥텟 범위 : 0~255
  - 최대 호스트 수 : 6만 5534대 (256\*256 -2)
  - 범위 : 128.0.0.0 ~ 191.255.255.255
- C클래스 (110으로 시작)
  - 첫 1옥텟 범위 : 192~223 (11000000 ~ 11011111)
  - 2~4 옥텟 범위 : 0~255
  - 최대 호스트 수 : 254개 (256 -2)
  - 범위 : 192.0.0.0 ~ 223.255.255.255
- 공인 IP 주소 범위
  - A 클래스
    - 1.0.0.0 ~ 9.255.255.255
    - 11.0.0.0 ~ 126.255.255.255
  - B 클래스
    - 128.0.0.0 ~ 172.15.255.255
    - 172.32.0.0 ~ 191.255.255.255
  - C 클래스
    - 192.0.0.0 ~ 192.167.255.255
    - 192.169.0.0 ~ 223.255.255.255
- 사설 IP 주소 범위
  - A 클래스
    - 10.0.0.0 ~ 10.255.255.255
  - B 클래스
    - 172.16.0.0 ~ 172.31.255.255
  - C 클래스
    - 192.168.0.0 ~ 192.168.255.255
- 따라서 가정의 랜에서 IP주소를 확인하면 보통 사설 IP인 192.168.X.X로 표현된다 (cmd ipconfig로 확인)

## IP주소의 네트워크 주소 & 브로드캐스트 주소

- IP주소에는 **네트워크 주소**와 **브로드캐스트 주소**가 존재한다
- 이 두 주소는 특별한 주소로 컴퓨터나 라우터가 자신의 IP로 사용하면 안되는 주소이다
- **네트워크 주소**: 호스트 ID가 10진수로 모두 0 (00000000)인 IP주소
- **브로드캐스트 주소**: 호스트 ID가 10진수로 모두 255 (11111111)인 IP주소
- 네트워크 주소는 전체 네트워크에서 작은 네트워크를 식별하는데 사용, 네트워크를 대표하는 주소
  - 192.168.1.0 이라는 네트워크 주소에 192.168.1.1~192.168.1.6의 컴퓨터들이 있다
- 브로드캐스트 주소는 네트워크에 있는 컴퓨터나 장비 모두에게 한번에 데이터를 전송하는데 사용되는 전용 IP주소
  - 192.168.1.255로 데이터 전송하면 192.168.1.0의 모든 컴퓨터에게 데이터를 브로드캐스팅한다

# 서브넷 (subnet)

- 네트워크를 분할하는 것을 **서브넷팅**(subneting)이라고 한다
- 분할된 네트워크를 **서브넷**(subnet)이라고 한다
- A클래스는 호스트가 24비트인데 1677만 7214개의 호스트 ID를 할당받는다
- 브로드캐스팅을 할 경우 모든 호스트 ID에 해당하는 IP주소로 패킷을 전송 => 네트워크 혼잡
- A클래스 같은 대규모 네트워크를 **작은 네트워크**로 분할하여 브로드캐스트 전송 범위를 좁힌다
- IP주소를 더 효과적으로 활용하는 방법중하나
- 서브넷을 활용하기 위해 호스트 ID를 서브넷 ID와 호스트 ID로 나눈다
- IP주소 = 네트워크 ID + 호스트 ID = 네트워크 ID + 서브넷 ID + 호스트 ID

## 서브넷 마스크 (subnet mask)

- IP주소를 서브넷팅하면 어디까지가 네트워크 ID이고, 어디부터가 호스트 ID인지 판단하기 힘듬
- **서브넷 마스크** 값 사용
- 서브넷 마스크는 **네트워크 ID**와 **호스트 ID**를 식별하기 위한 값
- 서브넷 마스크는 32비트 값이다
  - 서브네팅 전 기본 서브넷 마스크 값
  - A클래스: 255.0.0.0 , /8
  - B클래스: 255.255.0.0 , /16
  - C클래스: 255.255.255.0 , /24
- **프리픽스**(prefix) 표기법 : 슬래시(/비트수)로 표현
- C클래스를 서브네팅 해보자
  - C클래스의 네트워크 ID 24비트, 8비트의 호스트 ID에서 4비트를 서브넷으로 쓴다
  - 뒤의 8비트중 4비트가 서브네팅으로 사용됨 서브넷마스크 11110000
  - 255.255.255.240 (240 = 128+64+32+16)
  - = /28

# 라우터 (router)

- 서로 다른 네트워크와 통신하기 위한 3계층 장비
- 라우터는 **연결된 네트워크**를 분리할수 있다
- 라우터
  - 스위치 1 연결 (192.168.1.0/24 네트워크, 192.168.1.1 게이트 웨이)
    - 컴퓨터1
    - 컴퓨터2
    - 컴퓨터3
  - 스위치 2 연결 (192.168.2.0/24 네트워크, 192.168.2.1 게이트 웨이)
    - 컴퓨터4
    - 컴퓨터5
    - 컴퓨터6
  - 스위치 1과 2는 다른 네트워크를 가질수 있다
- 스위치 1
  - 스위치 2 연결
    - 컴퓨터1
    - 컴퓨터2
    - 컴퓨터3
  - 스위치 3 연결
    - 컴퓨터4
    - 컴퓨터5
    - 컴퓨터6
  - 스위치 1,2,3은 같은 동일한 네트워크에 속하게 된다
- 라우터로 분리된 네트워크에서 컴퓨터 한대가 다른 네트워크로 접속을 하려고 한다
  - ex) 컴퓨터 1 => 컴퓨터 6 접속
  - 먼저 라우터의 IP주소를 설정해야 된다
  - 이것은 네트워크의 출입구를 설정하는 것, 이것을 **기본 게이트웨이**(default gateway)라고 한다
  - 라우터의 IP 주소를 지정하는 이유는 컴퓨터 1은 다른 네트워크로 데이터를 보낼 때 어디로 전송해야하는지 알지 못하기 떄문, 일단 네트워크 출입구를 지정하고 라우터로 데이터를 전송
  - 추가로 라우팅이 필요함

## 라우팅

- **라우팅** : 경로 정보를 기반으로 현재의 네트워크에서 다른 네트워크로 최적의 경로를 통해 데이터를 전송
- **라우팅 테이블**: 경로 정보가 저장되어있는 테이블
- 각 라우터의 라우팅 테이블에 경로 정보가 등록되어 있어야 라우팅이 가능하다
- 라우팅 테이블 등록 방법
  - 수동: 관리자가 직접 등록, 소규모 네트워크에 적합, 라우팅 정보가 교환되지 않아 대역폭 부담이 적음, 보안 유지 더 좋음, 장애 발생시 우회 불가 (정적 라우팅)
  - 자동: 라우터간의 경로 정보를 서로 교환하여 라우팅 테이블 정보를 자동으로 수정, 대규모 네트워크에 적합 (동적 라우팅)
  - 자동시 라우터 간에 라우팅 정보를 교환하기 위한 프로토콜을 **라우팅 프로토콜**이라고 한다
  - 라우팅 프로토콜의 종류
    - RIP
    - OSPF
    - BGP

# ICMP (Internet Control Message Protocol, 인터넷 제어 메시지 프로토콜)

- 인터넷 제어 메시지 프로토콜(ICMP)은 네트워크 장치에서 네트워크 통신 문제를 진단하는 데 사용하는 **네트워크 계층 프로토콜**입니다.
- ICMP의 주요 목적은 오류 보고, 두 장치가 인터넷을 통해 연결되면 ICMP는 데이터가 의도한 대상에 도달하지 못한 경우 전송하는 장치와 공유할 오류를 생성합니다. 예를 들어 데이터 패킷이 라우터에 비해 너무 큰 경우 라우터에서는 패킷을 삭제하고 ICMP 메시지를 데이터의 원래 소스로 돌려보냅니다.

- ICMP 프로토콜의 보조 용도는 네트워크 진단을 수행하는 것입니다. 일반적으로 사용되는 터미널 유틸리티 traceRoute 및 ping은 모두 ICMP를 사용하여 작동합니다.

- traceroute 유틸리티는 두 인터넷 장치 간의 라우팅 경로를 표시하는 데 사용됩니다. 라우팅 경로는 요청이 대상에 도달하기 전에 통과해야 하는 연결된 라우터의 실제 물리적 경로입니다. 한 라우터와 다른 라우터 간의 여정을 '홉'이라고 하며, traceroute는 여정 중 각 홉에 필요한 시간도 보고합니다. 이는 네트워크 지연의 원인을 확인하는 데 유용할 수 있습니다.

- ping 유틸리티는 traceroute의 단순화된 버전입니다. ping은 두 장치 간의 연결 속도를 테스트하고 데이터 패킷이 대상에 도달하고 발신자의 장치로 돌아오는 데 걸리는 시간을 정확히 보고합니다. ping은 라우팅 또는 홉에 대한 데이터를 제공하지 않지만, 두 장치 간의 대기 시간을 측정하는 데 여전히 아주 유용한 메트릭입니다. ICMP 에코 요청 및 에코 응답 메시지는 일반적으로 ping을 수행하기 위해 사용됩니다.

- 불행히도 네트워크 공격은 이 프로세스를 악용하여 ICMP 폭주 공격 및 죽음의핑 공격과 같은 방해 수단을 만들 수 있습니다.

- 인터넷 프로토콜(IP)과는 달리, ICMP는 TCP 또는 UDP와 같은 전송 계층 프로토콜과 연결되지 않습니다.따라서 ICMP가 연결이 없는 프로토콜이 되므로 한 장치에서 ICMP 메시지를 보내기 전에 다른 장치와의 연결을 수행할 필요가 없습니다.

- 주로 `ping` 명령으로 ICMP 패킷을 전송하고 패킷에 대한 응답이 제대로 오는지 확인하는데 사용
