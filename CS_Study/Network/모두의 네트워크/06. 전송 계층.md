# 전송 계층 (Transport layer)

- 전송 계층은 **목적지에 신뢰할 수 있는 데이터를 전달**하기 위해 필요
- 전송 계층은 **오류를 점검하는 기능**이 있다
- 전송 계층은 **전송된 데이터의 목적지가 어떤 애플리케이션인 식별하는 기능**이 있다
- 물리계층, 데이터 링크 계층, 네트워크 계층 3계층이 있으면 목적지에 데이터를 보내는 것이 가능
- 하지만 데이터가 손상되거나 유실되더라도 하위 3계층은 아무것도 해주지 않는다

## 연결형 통신 & 비연결형 통신

- 신뢰성/ 정확성 (데이터를 문제없이 전달)=> 연결형 통신
- 효율성 (데이터를 빠르게 전달)=> 비연결형 통신
- 연결형 통신은 상대와 확인해 가면서 통신하는 방식이고(여러번 왔다갔다), 비연결형 통신은 확인하지 않고 일방적으로 보낸다(한번)
- 대부분은 정확한 데이터를 위해 연결형 통신을 사용
- 비연결형 통신은 보통 동영상처럼 일부가 유실되어도 문제없는 경우 사용
- 대표적인 연결형 통신 프로토콜 TCP
- 대표적인 비연결형 통신 프로토콜 UDP

# TCP (Transmission Control Protocol)

- 연결형 통신 프로토콜의 한 종류
- TCP는 전송 계층의 프토로콜의 일종으로 **TCP 헤더**를 붙인다
- TCP헤더가 붙은 데이터를 **세그먼트**(segment)라고 한다
- TCP 헤더 구조
  - 출발지 포트 번호 (16비트)
  - 목적지 포트 번호 (16비트)
  - 일련번호 (32비트)
  - 확인 응답 번호(32비트)
  - 헤더 길이 (4비트)
  - 예약 영역 (6비트)
  - 코드 비트 (6비트)
  - 윈도우 크기 (16비트)
  - 체크섬 (16비트)
  - 긴급 포인터 (16비트)
  - 옵션
- TCP는 연결형 통신이기 때문에 데이터 전송 전에 **연결**(connection)이라는 **가상의 독점 통신로를 확보**해야 한다. 연결을 확립후 데이터 전송 가능
- TCP의 코드 비트 (각 1비트)
  - URG
  - ACK
  - PSH
  - RST
  - SYN
  - FIN
- 각 코드 비트의 초깃값은 0이고 비트가 활성화되면 1
- 연결을 위해서는 ACK, SYN이 필요하다
- **SYN**은 연결 요청
- **ACK**은 확인 응답
- **FIN**은 연결 종료

## 3-way 핸드셰이크 (3-way handshake)

- 연결을 확립하기위한 TCP의 과정, 마치 상대방을 확인하고 악수를 하는것 같아서 이름을 붙였다
- 신뢰할 수 있는 연결을 하려면 데이터를 전송하기 전에 패킷을 교환하는데, 확인을 세번한다
- 과정
  1. 통신을 하려면 상대 컴퓨터의 허가를 받기위해 연결 확립 허가인 SYN 요청을 보낸다
  2. 상대가 보낸 요청을 받은후 허가하겠다는 응답을 회신하기위해 연결 확립 응답 ACK를 보낸다. 이때 자신도 데이터 전송 허가를 받기위한 연결 확립 요청 SYN을 같이 보낸다
  3. 상대가 다시 보낸 요청을 받은 컴퓨터는 연결을 허가한다는 응답으로 연결 확립 응담 ACK를 보낸다
- 과정을 비트로 보기
  1. SYN을 1로 해서 요청을 보냄
  2. 요청 수락을 위해 ACK를 1로 만들고, 이쪽에서도 요청을 위해 SYN도 1로해서 응답을 보냄
  3. 요청 수락을 확인했고, 이쪽도 요청 수락했다는 뜻으로 ACK를 1로 해서 보냄

## 4-way 핸드셰이크 (4-way handshake)

- 연결을 종료하기 위한 TCP의 과정
- 과정
  1. 컴퓨터 1이 연결 종료 요청 FIN을 컴퓨터 2에게 보낸다
  2. 컴퓨터 2에서 컴퓨터 1로 연결 종료 응답 ACK를 반환한다
  3. 컴퓨터 2에서 컴퓨터 1로 연결 종료 요청 FIN을 보낸다
  4. 컴퓨터 1에서 컴퓨터 2로 연결 종료 응답 ACK를 반환한다
- 과정을 비트로
  1. FIN을 1로 보내기
  2. ACK 1로 답장
  3. FIN을 1로 보내기
  4. ACK 1로 답장

## 일련번호 (sequence number)와 확인 응답 번호(acknowledgement number)의 구조

- 3 way 핸드셰이크로 연결 확립 이후, 실제 데이터를 보내거나 상대방이 받을때 **일련번호**와 **확인 응답 번호**를 사용
- 일련번호: 송신측에서 수신 측에 이 데이터가 **몇 번쨰 데이터**인지 알려주는 역할
- 확인 응답 번호: 수신 측에서 **몇 번째 데이터**를 수신했는지 송신 측에 알려주는 역할
- 확인 응답 번호는 다음 번호의 데이터를 요청하는데도 사용된다. 10번 데이터를 수신했으면 11번 데이터를 송신측에 요청 이를 **확인 응답**이라고 한다
- 일련번호 3001번 200바이트 데이터를 보내는 과정
  1. 3-way 핸드셰이크로 연결 수립이 이루어 질때 일련번호와 확인 응답 번호 결정
  2. 컴퓨터 1은 컴퓨터 2로 200바이트 데이터 전송 (일련번호 3001 , 확인 응답 번호 4001)
  3. 컴퓨터2는 200바이트 수신하고 다음 수신하고자 하는 데이터 번호를 확인 응답 번호에 넣는다 (일련번호 4001, 확인 응답 번호 3201)
  4. 컴퓨터1은 컴퓨터2로 3201번부터 200바이트 데이터를 전송 (일련번호 3201, 확인 응답 번호 4001)
  5. 컴퓨터2는 200바이트 수신하고 다음에 수신하고자 하는 데이터 번호를 확인응답번호에 넣는다
     (일련번호 4001, 확인 응답 번호 3401)
  6. 2~5과정 데이터 전송 완료까지 반복
- 데이터가 항상 올바르게 전달되는 것은 아니므로 일련번호와 확인 응답 번호를 사용해서 데이터가 손상되거나 유실된 경우에 데이터를 재전송하게 된다. 이것을 **재전송 제어**라고 한다
- 재전송 제어는 데이터 전송중 오류가 발생하면 일정 시간동안 대기후에 재전송한다
