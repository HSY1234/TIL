# 라우팅

- **라우팅** : 데이터그램의 수신처 IP 주소를 근거로 다음에 송신하는 라우터를 결정하는 과정
- IP 주소: 수신처의 컴퓨터를 결정 = **데이터의 최종 수신처**
- MAC 주소: 같은 네트워크 내에서의 수신처를 결정 = **그 다음의 수신처**
- 인터넷 작업에서 데이터는 **복수의 네트워크를 경유**해 최종 수신 컴퓨터에 도달
- 네트워크 A에서 네트워크 B를 통해 네트워크C에 가는 경우
  - 데이터는 A => B, B=> C 로 갈때 B에 들어간 시점에 C로 중계해줄 어딘가의 장소로 가야한다
  - 이 어딘가의 장소를 **MAC 주소**로 지정해서 다음으로 보낼 장소를 결정
  - MAC 주소는 다음 수신처이기 떄문에 MAC주소는 **계속 변경 된다**
  - IP주소는 데이터의 최종 수신처이므로 **변경이 없다**
- 즉 MAC 주소를 기반을 다음 - 다음 - 다음으로 넘어가고, 최종 목적지인 IP까지 **경로**가 만들어진다
- **라우터**라는 장치가 **경로**를 결정하는 역할을 한다 (정확히는 경로의 일부)
- 라우터는 한번에 송신처에서 수신처까지 모든 경로를 정하는게 아닌, **다음에 어디로 보내야 할지**만 결정
- 이렇게 다음 길을 제시해 가는 방식을 **홉 바이 홉**(Hop-by-Hop)이라고 한다
- 라우팅에서 **홉**이란 라우터를 가리킨다
- 라우터는 **네트워크의 경계상**에 배치되어 전송받은 데이터그램을 라우팅한다
- 다음 수신처는 **수신처에 가기 위한 다음 라우터**를 의미한다 (최종 수신처일 경우만 예외)
- 라우터 없이는 **다른 네트워크에 데이터그램을 보낼수 없다**
- 만약 허브로 같은 멀티액세스 네트워크에 다른 네트워크 컴퓨터가 연결되어 있어도 데이터그램이 전달되지 않는다
- 허브로 보내면 플로딩 되니까 전달되는거 아닌가?
  - 수신처가 **다른 네트워크**면 라우터로 송신한다
  - 수신처가 **같은 네트워크**면 수신처에 직접 송신한다
  - 두 규칙은 무조건 지켜지기 떄문에, 라우터가 없이는 다른 네트워크가 직접 연결되어 있어도 전송 불가
- 즉 라우터가 설정되어 있지 않다면 다른 네트워크에 대한 데이터 전송은 아예 불가능하다 (동일은 당연히 가능)
- 이 경우 컴퓨터가 지정하는 라우터를 **디폴트 게이트웨이**(Default Gateway)라고 한다

# 라우터

- 3계층 인터넷 작업은 네트워크간의 데이터 전송이므로 3계층 장비인 라우터가 없으면 다른 네트워크에 데이터를 보낼수 없다
- 라우터는 네트워크의 경계상에 배치된다
- 한 라우터는 **복수의 네트워크**와 연결되어있다
- 즉 네트워크와 네트워크의 경계상에 배치되기 떄문에 **복수의 인터페이스**를 가질수 있다
- 각 인터페이스마다 논리 주소인 **IP주소**가 설정되어있다. 그러므로 라우터의 각 인터페이스는 **각각의 네트워크에 소속된다** = 라우터는 복수의 네트워크에 소속된다
- 라우터의 역할
  - 라우팅 : 경로를 결정
  - 연결 : 복수의 네트워크끼리 연결, LAN인 이더넷, WAN으로 사용되는 회선
  - 필터링 : 전송받은 데이터그램에 조건을 붙여 데이터그램을 파기나 분류

## 라우팅 테이블

- 라우팅 테이블: **최적 경로의 지도**, 라우터의 중요한 요소
  - 수신처 IP
  - 수신처 네트워크까지의 거리
  - 다음에 도달하는 라우터
  - 그 라우터에 연결되어 있는 자신의 인터페이스
  - 등등
- 라우팅 테이블에서 다음 수신처를 찾는 방법은 **최장일치 룰**(Longest Match)
- 실제 데이터를 보낼 수신처 IP주소로부터 라우팅 테이블의 수신처 네트워크 주소를 결정해 다음 라우터와 송신 인터페이스를 결정하는데, 수신처 IP주소와 수신처 네트워크 주소를 비교할떄 비트열이 가장 많이 일치하는것부터 선택
- 프리픽스 길이까지 일치한것 중에서도 가장 프리픽스 길이가 긴 경로를 사용한다

# 디폴트 게이트웨이

- 디폴트 게이트 웨이 : 컴퓨터가 내보낼 라우터 = **네트워크의 출입구**
- 다른 네트워크에 데이터그램을 송신할 때 반드시 디폴트 게이트웨이로 송신한다
- 다른 네트워크로 데이터를 전송하고 싶은 호스트는 일단 **디폴트 게이트웨이로 데이터를 보내서 다른 네트워크로 전송한다**
- **컴퓨터가 다른네트워크로 데이터를 보내는 수신처는** 디폴트게이트 웨이다

## ARP의 문제점

- **브로드캐스트는 라우터를 넘어서 전송할 수 없다**
- 라우터가 네트워크를 나누기 떄문에 브로드캐스트가 다른 네트워크에 전송되지 않고, 송신양이 감소
- 브로드캐스트 도메인 : 브로드캐스트가 도달하는 범위
- 충돌 도메인은 **스위치**, 브로드캐스트 도메인은 **라우터**가 기준이다
- 브로드캐스트 도메인 = 사실상 네트워크 라고 생각해도 무방
- **ARP는 브로드캐스트** => ARP는 다른 네트워크의 **수신처까지 도달할수가 없다!**(라우터가 막음) => 우리가 원하는 MAC주소를 알수 없음

## ARP 상세 해결법

- 컴퓨터는 다른 네트워크로 데이터를 송신할때 디폴트 게이트웨이로 ARP를 수행 =>**디폴트 게이트웨이의 MAC주소**를 얻는다
- 동일 네트워크라면 수신처의 IP주소 수신으로 ARP를 실행해서 그 컴퓨터의 MAC주소를 입수
- 다른 네트워크라면 디폴트게이트웨이의 IP로 ARP를 실행해서 디폴트 게이트웨이의 MAC주소를 입수
- **디폴트 게이트웨이의 IP**를 모르면 안되기 떄문에, 컴퓨터에 디폴트 게이트 웨이의 IP 주소를 **미리 설정**해둔다 (수동이나 DHCP로)

## 다른 네트워크 ARP 과정

1. 다른 네트워크에 데이터를 보내는 경우, 호스트는 디폴트 게이트웨이로 ARP를 수행해 디폴트게이트 웨이의 MAC주소 획득
2. 호스트는 수신처 MAC주소를 디폴트게이트웨이 주소로, 수신처 IP주소는 그대로 두고 패킷을 보낸다
3. 수신 받은 디폴트 게이트웨이는 라우팅을 하고, 중계 라우터, 송신포트등을 결정하여 다음에 수신 받을 상대 (중계 라우터 또는 수신처)에게 ARP 수행
4. ARP에 입수한 MAC 주소를 수신처 MAC 주소로, 자기자신의 MAC 주소를 송신처 MAC주로 갱신하여 송신 IP주소는 변경 X

# 라우팅

## 라우팅 테이블과 정적 동적 라우팅

- 라우팅 테이블
  - 수신처 네트워크 : 수신처의 IP
  - 중계 지점 : 다음 라우터
  - 메트릭 : 중계 거리
  - 수신처의 출구 : 인터페이스 번호
- 라우팅 테이블에 **수신처 네트워크가 없을때** => **수신처 불명으로 데이터그램 파기**
- 수신처 네트워크까지 최적 경로를 어떻게 알아낼까?
- 원래 라우팅 테이블에 수신처까지의 경로가 기재되어 있는데 그건 어떻게 한걸까?
- 라우터는 최적경로를 알기위해 **다른 네트워크 경로를 모두 알아야 할 필요가 있다**
- 알고있는 경로중에서 최적의 경로를 선택해서 라우팅 테이블을 작성
  - **정적 라우팅** : 관리자가 수동으로 경로를 입력, 장애가 일어나면 우회로를 수동으로 매번 갱신해야할 필요가 있다
  - **동적 라우팅** : 라우터가 자동으로 정보를 서로 교환해서 경로를 알아내는 방법, 모든 경로중에서 자동으로 최적의 경로를 선택해서 라우팅 테이블을 작성
    - 단점 1 : 라우터끼리 정보를 교환하는것도 데이터를 주고받는것이므로 회선 전송을 압박 (저속 회선은 특히 주의)
    - 단점 2 : 서로 교환한 정보를 가지고 최적의 경로를 계산해야하므로 라우터의 처리능력 필요 (지나치면 데이터그램 전송이 늦어짐)
    - 단점 3 : 최대 단점 **모든 라우터가 동일한 정보를 가져야 한다** = 네트워크 라우터들이 **컨버전스**(Convergence) 상태가 되어야한다 (예를 들어 고장난 라우터 정보를 한쪽은 알고 다른쪽이 모르면 우회했지만 다시 고장난 라우터로 데이터그램 전송이 일어날수 있다)
    - 이 모든 단점에도 불구하고 **자동으로 장애를 제거한다는것은 매우 중요**

# 라우팅 프로토콜

- 어떤 장애가 발생했을때 우회로를 만드는 등 **중복성 유지**(네트워크의 여분이나 중복이 있어 장애에 대응하는 능력)를 위해 **동적 라우팅**을 이용하는 경우가 많다.
- 동적라우팅을 실현할 **라우팅 프로토콜**(Routing Protocol)을 사용할 수 있도록 되어 있다
- **라우팅 프로토콜** : 근접해 있는 라우터간의 네트워크 정보를 서로 교환하기 위한 규칙
- 라우팅 프로토콜로 교환한 정보를 근거로 라우팅 테이블을 라우터는 변경한다
- 라우팅 프로토콜의 핵심
  1. 어떻게 교환 할것인가
  2. 교환한 데이터를 어떻게 라우팅 테이블에 반영할것인가

## 자율화 시스템 (AS, Autonomous System, 경로 도메인, 경로제어 도메인)

- **하나의 관리 단체에 의해 관리되는 네트워크 집합체**
- 라우팅에서는 AS는 한개의 범위로 취급
- 인터넷에 너무 많은 네트워크가 존재하기 때문에, 같은 조직이 관리하는 복수 네트워크는 AS로 통합
- 수신처의 AS에 전달하는 라우팅을 수행하고, AS 내부에서 각 네트워크에 전달하는 라우팅을 수행
- AS는 식별을 위해 **유일한 번호**가 부여되어 있다
- 복수의 네트워크를 통합해서 큰 단위의 라우팅을 수행한다고 생각

## 라우팅 프로토콜의 종류 (추가학습 예정 디스턴스 벡터, 링크상태, 경로 벡터, 하이브리드)

- AS 간 라우팅용 (**EGP**, Exterior Gateway Protocol)
  - BGP
- AS 내부 라우팅용 (**IGP**, Interior Gateway Protocol)
  - RIP
  - OSFP
  - IS-IS
  - EIGRP

## 라우팅 프로토콜의 역할

- 근접해 있는 라우터간의 네트워크 정보를 서로 교환한다 => 컨버전스 상태에 도달이 목표
  - 정보교환을 언제할것인가?
  - 정보교환을 어떻게 할것인가?
  - 정보교환을 누구에게 할것인가?
  - 어떤 정보를 전송할것인가?

## 메트릭 (Metric)

- 라우팅에서 **최적의 경로를 결정할 판단기준**를 의미한다
- 최적은 최단, 최고속과 다르다.
  - 최단 경로가 최적 경로가 아닐수 있다 (회선이 느리거나, 전송량이 많은 상태)
  - 최고속 경로가 최적 경로가 아닐수 있다 (속도는 빠르지만 거리가 먼 경우)
- 메트릭의 계산하는 판단기준은 라우팅 프로토콜 마다 다르다
  - 중계하는 라우터 수
  - 회선의 속도
  - 정체 상태
  - 에러 발생률
  - 등등
- 라우팅 프로토콜에 의해 결정된 값을 계산해 **최소값을 갖는것을 최적의 경로**로 결정
- 가장 간단한 예시) 홉수만으로 결정 한다면 홉수가 적은 경로가 최적 경로이고, 메트릭은 홉수를 기준으로 계산한다. 홉수가 더 긴 경로는 라우팅 테이블에 적지 않는다

# RIP

- RIP는 디스턴스 벡터 기반 (거리 와 방향)
- RIP에서는 라우터가 다른 라우터와 교환하는 정보를 **라우팅 업데이트**(Routing Update)라고 한다
- RIP는 **30초에 1번씩** **라우팅 테이블을 그대로 교환한다**
- 업데이트를 **6번 수신** 받지 않으면 그 라우터에 장애가 발생했다고 간주후 해당 라우터를 사용하는 경로 파기
- RIP는 메트릭을 **홉 수**로 사용한다 (수신처 네트워크까지 통과하는 라우터 수)
- 직접 접속된 네트워크는 홉 수가 0이다
- RIP는 업데이트를 수신하면, 자기가 모르는 네트워크는 테이블에 추가한다
  - 업데이트를 보낸 라우터를 다음 중계 라우터로, 인터페이스를 받은 인터페이스를 송신 인터페이스로 설정
- RIP에서 이미 존재하는 네트워크에 대한 업데이트는 **새로운 경로 쪽이 메트릭티 작으면** 그쪽으로 테이블을 기재한다

# ICMP (Internet Control Message Protocol)

- 인터넷 제어 메세지 프로토콜은 3계층의 프로토콜로 **에러 보고 프로토콜**이다
- 예를 들어, 라우터가 수신처 네트워크 경로를 알수없으면 송신 불능 메시지를 ICMP로 송신 호스트에게 통지한다
- ICMP 메세지는 IP 데이터그램에 넣는다
- **ICMP 메세지**는 ICMP에 사용되는 정보로, IP 데이터 그램의 페이로드에 넣는다. (보통은 TCP 세그먼트나 UDP 데이터그램이 들어가는 자리에 대신)
- ICMP 메세지
  - 타입 : ICMP의 종류
  - 코드 : 상세 정보
  - 체크섬
  - 옵션
  - 데이터

## ICMP의 종류

- Query 메세지 : **상태를 조사**하기 위해 사용되는 메세지
- Error 메세지 : **에러를 통지**하기 위해 사용되는 메세지
