# JVM

![JVM 구조](img/JVM-Architecture.png)

## JVM 동작순서 큰 그림

1. 자바로 개발된 프로그램을 실행하면 JVM은 OS로부터 메모리를 할당
2. Class Loader를 통해 JVM Runtime Data Areas로 로딩
3. Runtime Data Areas에 로딩 된 .class들은 Execution Engine을 통해 해석
4. 해석된 바이트 코드는 Runtime Data Areas의 각 영역에 배치되어 수행하며 이 과정에서 Execution Engine에 의해 GC의 작동과 스레드 동기화가 이루어짐

# 클래스 로더

- 자바는 동적으로 클래스를 읽어오므로, 프로그램이 실행 중인 런타임에서야 모든 코드가 자바 가상 머신과 연결된다.
- 이렇게 동적으로 클래스를 로딩해주는 역할을 하는 것이 바로 **클래스 로더(class loader)**
- 자바에서 .java 소스파일을 작성하면 컴파일러가 컴파일을 통해 .class파일을 생성
- 클래스 로더는 .class 파일을 묶어서 JVM이 운영체제로부터 할당받은 메모리 영역인 Runtime Data Areas로 적재
- Loading : 클래스를 읽어오는 과정
- Linking : 레퍼런스를 연결하는 과정
- Intialization : Static 값들 초기화 및 변수에 할당

# 런타임 데이터 영역 (Runtime Data Area)

- JVM의 메모리 영역으로 자바 애플리케이션이 실행될때 사용되는 데이터가 적재하는 영역
- 힙 영역과 메서드 영역은 모든 스레드가 공유한다
- 스택 영역과 PC 레지스터 네이티브 메서드 스택 영역은 스레드 하나마다 영역이 존재

## 메소드 영역

- 클래스 수준의 정보(클래스 이름, 부모 클래스 이름, 메소드, 변수) 저장

## 힙 영역

- 객체를 저장, 공유하는 영역

## 스택 영역

- 쓰레드 마다 런타임 스택을 만들고, 그 안에 메소드 호출을 스택프레임이라는 블럭으로 쌓는다
- 쓰레드 종료시 런타임 스택이 사라진다

## 프로그램 카운터 레지스터

- 쓰레드마다 쓰레드 내 현재 실행할 instruction의 위치를 가리키는 포인터

## 네이티브 메소드 스택

# 실행 엔진 (Execution Engine)

- 클래스 로더에 의해 JVM으로 로드된 .class 파일(바이트코드)들은 Runtime Data Areas의 Method Area에 배치
- 배치된 이후에 JVM은 Method Area의 바이트 코드를 실행 엔진(Execution Engine)에 제공하여, 정의된 내용대로 바이트 코드를 실행
- 로드된 바이트코드를 실행하는 런타임 모듈이 **실행 엔진**(Execution Engine), 실행 엔진은 바이트코드를 명령어 단위로 읽어서 실행합니다.

## 인터프리터

- 바이트 코드를 한줄씩 실행

## JIT 컴파일러

- 인터프리터는 각 줄 매번 읽고 실행하기 때문에 느림
- 인터프리터가 반복되는 코드를 발견하면 JIT 컴파일러로 반복되는 코드를 모두 **네이티브 코드**(인터프리터 없이 컴퓨터에서 바로 실행되는 컴파일된 코드)로 바꾼다
- 인터프리터는 해당 네이티브 코드를 바로 실행한다

## 가비지 컬렉터 (gabage Collector)

- 자바 가상 머신은 가비지 컬렉터(garbage collector)를 이용하여 더는 사용하지 않는 메모리를 자동으로 회수
- 따라서 개발자가 따로 메모리를 관리하지 않아도 되므로, 더욱 손쉽게 프로그래밍을 할 수 있다
- Heap 메모리 영역에 생성(적재)된 객체들 중에 참조되지 않은 객체들을 탐색 후 제거하는 역할, 해당 역할을 하는 시간은 정확히 언제인지를 알 수 없다. (설정을 바꿀수도 있음)
- GC역할을 수행하는 스레드를 제외한 나머지 모든 스레드들은 일시정지상태 됨

# JNI(Java Native Interface)

- 자바 애플리케이션에서 C, C++, 어셈블리로 작성된 함수를 사용할 수 있는 방법을 제공
- Native 키워드를 사용한 메소드 호출
- 사용하는 이유
  - 이미 존재하는 방대한 C/C++ 코드를 활용하기 위해
  - Java로 구현하면 너무 느린 기능의 속도 향상을 위해
  - JVM에서 지원하지 않는 운영체제의 기능을 호출하기 위해

# 네이티브 라이브러리 메소드

- C, C++로 작성 된 라이브러리
- 네이티브 라이브러리 메소드를 사용하려면 자바는 반드시 JNI로 호출해야한다
