# 커널(kernel)

- 운영체제의 심장
- 운영체제에는 다양한 기능이 있지만, 자원에 접근하고 조작하는 기능, 프로그램이 올바르고 안전하게 실행되게 하는 기능등이 운영체제의 핵심 서비스에 속한다.
- 이런 핵심서비스를 담당하는 부분을 **커널**이라고 한다.
- 커널에 속하지 않는 대표적인 운영체제 서비스 => 사용자 인터페이스(User Interface)
  - GUI(Graphic User Interface)
  - CLI(Command Line Interface)
  - 그저 컴퓨터와 상호작용하기 위한 통로일 뿐 커널에 속한 기능X

# 운영체제의 핵심 서비스

- 프로세스 관리
  - **프로세스**(process)란 실행중인 프로그램
  - CPU는 한번에 하나의 프로세스의 명령어만 실행하므로, 프로세스를 번갈아가며 실행
  - 어떤 프로세스를 다음에 실행할것인가? => 프로세스 스케줄링
  - 프로세스 동기화
  - 프로세스 교착상태 해결
- 자원 접근 및 할당
  - CPU
    - 프로세스들에게 공정하게 CPU를 할당하기 위해 어떤 프로세스부터 쓸것인지
    - CPU 스케줄링
  - 메모리
    - 프로세스에게 어떻게 메모리를 할당해야 효율적인가?
    - 프로세스를 어디에 할당해야하는가?
    - 메모리가 부족하면 어떻게 해야하는가?
  - 입출력 장치
    - 입출력 장치의 하드웨어 인터럽트를 어떻게 처리 할것인가?
- 파일 시스템 관리
  - 디렉터리로 관리를 어떻게 할것인가?

# 이중 모드(dual mode)

- 운영체제는 사용자가 실행하는 응용 프로그램이 하드웨어 자원에 **직접 접근**하는 것을 방지하여 자원을 보호함
- 응용프로그램이 직접 건드릴수있게 할 경우, 서로 다른 응용프로그램이 같은 부분을 건드려 문제 발생
- 즉 하드웨어 자원은 운영체제만이 조작할 권한이 있음
- 운영체제는 응용 프로그램들이 자원에 접근하려고 할때, 무조건 자신을 거쳐가게 하여 자원을 보호
- 응용프로그램은 따라서 자원을 쓰기 위해 운영체제에게 도움을 요청(자원 쓰게 해주세요) = 운영체제의 코드를 일부 실행 해주세요
- 응용프로그램의 요청을 받은 운영체제는 대신 자원에 접근해 요청한 작업을 수행
- 예시
  1. 응용프로그램이 하드디스크에 저장을 요청(운영체제에게)
  2. 운영체제는 요청을 분석해 운영체제의 하드디스크에 저장하는 코드를 실행
  3. 하드디스크에 실제로 저장
- **이중 모드**(dual mode)란 이런 운영체제의 문지기 역할을 구현하기 위한 방법
- 이중모드란 CPU가 명령어를 실행하는 모드를 **사용자 모드** 와 **커널 모드**로 구분하는 방식
- 사용자 모드, 커널 모드 실행은 플래그 레지스터 속 슈퍼바이저 플래그를 보면 알수 있다

## 사용자 모드(User mode)

- 운영체제의 서비스를 제공 받을수 없는 실행 모드
- 커널 영역의 코드를 실행시키지 못하는 모드
- 일반적인 응용프로그램 기본적으로 사용자 모드
- 사용자 모드로 실행중인 CPU는 입출력 명령처럼 하드웨어 자원에 접근하는 명령어 실행 불가

## 커널 모드(kernel mode)

- 운영체제 서비스를 제공 받을수 있는 실행 모드
- 커널 영역의 코드를 실행할수 있는 모드
- CPU가 커널 모드로 명령어를 실행하면 자원에 접근하는 명령어를 비롯해 모든 명령어 실행가능
- 자원접근 가능!

# 시스템 호출(시스템 콜, system call)

- 사용자 모드로 실행되는 프로그램이 자원에 접근하는 운영체제 서비스를 제공 받기 위해 운영체제에 요청을 보내 커널 모드로 변경해야함
- 이때 운영체제 서비스를 받기 위해 보내는 요청을 **시스템 호출**(시스템 콜,system call)이라고 함
- 시스템 콜은 일종의 인터럽트(소프트웨어적 인터럽트, 동기 인터럽트의 한 종류, CPU가 발생시킴)

## 과정

- 기존 인터럽트 처리와 유사함

1. 시스템 호출을 발생시키는 명령어가 실행
2. CPU는 지금까지 작업을 백업
3. 커널 영역내의 시스템 호출을 수행하는 코드(인터럽트 서비스 루틴)을 실행
4. 완료 후 기존 실행하던 응용 프로그램으로 복귀

- 예시
  1. 응용 프로그램이 하드디스크에 정보를 저장하려고 함 => 커널모드로 전환 필요
  2. 하드디스크에 데이터를 저장하는 시스템 호출을 발생시켜 커널 모드로 전환
  3. 운영체제 내의 하드 디스크에 데이터를 저장하는 코드를 실행
  4. 하드디스크 접근이 끝났으면 사용자 모드로 복귀
  5. 응용 프로그램이 마저 실행됨

## 시스템 호출의 종류

- POSIX 운영체제의 예시(유닉스, 리눅스)
- 프로세스 관리
  - fork() : 새 자식 프로세스 생성
  - execve() : 프로세스 실행
  - exit() : 프로세스 종료
  - waitpid() : 자식 프로세스 종료까지 대기
- 파일 관리
  - open() : 파일 열기
  - close() : 파일 닫기
  - read() : 파일 읽기
  - write() : 파일 쓰기
  - stat() : 파일 정보 획득
- 디렉터리 관리
  - chdir() : 작업 디렉터리 변경
  - mkdir() : 디렉터리 생성
  - rmdir() : 비어있는 이렉터리 삭제
- 파일 시스템 관리
  - mount() : 파일 시스템 마운트
  - unmount() : 파일 시스템 마운트 해제
- 등등
- 개발자가 작성하는 프로그래밍 언어들은 내부적으로 위와 같은 시스템 호출을 통해 실행(printf, scanf 등등)

# 가상 머신

- 이중 모드는 커널 모드와 사용자 모드를 제공하는 실행 모드
- 그러나 **가상 머신**을 통한 **가상화**를 지원하는 현대 CPU는 두 가지 이상의 모드를 제공
- 가상머신(virtual machine)이란 소프트웨어적으로 만들어낸 가상의 컴퓨터
- 가상머신에는 새로운 운영체제와 응용 프로그램을 설치하고 실행 가능
- 가상머신 또한 응용프로그램의 일종이기 때문에 **사용자 모드**로 작동
- 가상 머신상에 설치된 운영체제도 사용자 모드로 작동할텐데, 운영체제 서비스를 제공하기 위해서는 사용자 모드말고 커널모드로 전환이 필요하다
- 그래서 가상화를 지원하는 CPU는 커널모드와 사용자 모드이외에 가상 머신을 위한 모드 **하이퍼 바이저 모드**를 따로 둔다
- 즉 가상 머신상에서 작동하는 응용 프로그램은 하이퍼바이저 모드로써 가상 머신에 설치된 운영체제로 부터 운영체제 서비스를 받는다
